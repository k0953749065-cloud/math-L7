import React, { useState, useEffect, useRef, useCallback } from 'react';
import { 
  Play, BookOpen, Calculator, Award, 
  Heart, Star, RefreshCw, ChevronRight, 
  HelpCircle, CheckCircle, XCircle, Trophy,
  Map, Trees, Anchor, Castle, Rocket, Wand2,
  Home, ArrowRight, MousePointer2, GraduationCap,
  Mic, Square, Volume2, RotateCcw, Music,
  PieChart, Ruler, Scissors, Shapes, Circle
} from 'lucide-react';

// --- è³‡æ–™èˆ‡é¡Œåº« ---

const THEMES = {
  forest: { name: 'è¿·éœ§æ£®æ—', color: 'bg-green-100', accent: 'text-green-600', button: 'bg-green-500 hover:bg-green-600', icon: Trees },
  ocean: { name: 'æ·±è—æµ·æ´‹', color: 'bg-blue-100', accent: 'text-blue-600', button: 'bg-blue-500 hover:bg-blue-600', icon: Anchor },
  castle: { name: 'å¹¾ä½•åŸå ¡', color: 'bg-slate-100', accent: 'text-slate-600', button: 'bg-slate-500 hover:bg-slate-600', icon: Castle },
  space: { name: 'ç„¡é‡åŠ›å¤ªç©º', color: 'bg-indigo-100', accent: 'text-indigo-600', button: 'bg-indigo-500 hover:bg-indigo-600', icon: Rocket },
  magic: { name: 'é­”æ³•å­¸é™¢', color: 'bg-purple-100', accent: 'text-purple-600', button: 'bg-purple-500 hover:bg-purple-600', icon: Wand2 },
};

const LEVELS = [
  {
    id: 'forest',
    title: 'ç¬¬ä¸€é—œï¼šèªè­˜åœ“å‘¨ç‡',
    desc: 'æ‰¾å‡ºåœ“å‘¨é•·èˆ‡ç›´å¾‘çš„ç¥•å¯†é—œä¿‚ï¼',
    theme: 'forest',
    learnSteps: [
      { text: "æ­¡è¿ä¾†åˆ°è¿·éœ§æ£®æ—ï¼æˆ‘å€‘è¦å…ˆèªè­˜åœ“çš„ç¥•å¯†ã€‚", highlight: "intro" },
      { text: "ä¸ç®¡åœ“æ˜¯å¤§æ˜¯å°ï¼Œåªè¦ç”¨ã€Œåœ“å‘¨é•· Ã· ç›´å¾‘ã€ï¼Œç­”æ¡ˆéƒ½å¤§ç´„æ˜¯ 3.14ã€‚", highlight: "concept" },
      { text: "é€™å€‹ 3.14 æˆ‘å€‘å«å®ƒã€Œåœ“å‘¨ç‡ã€ã€‚", highlight: "term" },
      { text: "æ‰€ä»¥å…¬å¼æ˜¯ï¼šåœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14", highlight: "formula" },
      { text: "ç¯„ä¾‹ï¼šç›´å¾‘ 10 å…¬åˆ†çš„åœ“ï¼Œå‘¨é•·æ˜¯ 10 Ã— 3.14 = 31.4 å…¬åˆ†ã€‚", highlight: "example" }
    ],
    problems: [
      {
        q: 'ç›´å¾‘ 10 å…¬åˆ†çš„åœ“ï¼Œåœ“å‘¨é•·å¤§ç´„æ˜¯å¤šå°‘å…¬åˆ†ï¼Ÿ(åœ“å‘¨ç‡ä»¥ 3.14 è¨ˆç®—)',
        options: ['31.4', '314', '15.7', '62.8'],
        ans: '31.4',
        hint: 'åœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14',
        explanation: 'åœ“å‘¨é•·å…¬å¼ç‚ºï¼šç›´å¾‘ Ã— 3.14ã€‚\n10 Ã— 3.14 = 31.4 (å…¬åˆ†)'
      },
      {
        q: 'ä¸€å€‹åœ“çš„ç›´å¾‘è®ŠæˆåŸä¾†çš„ 2 å€ï¼Œåœ“å‘¨é•·æœƒè®ŠæˆåŸä¾†çš„å¹¾å€ï¼Ÿ',
        options: ['2 å€', '3.14 å€', '4 å€', 'ä¸è®Š'],
        ans: '2 å€',
        hint: 'åœ“å‘¨é•·å’Œç›´å¾‘æ˜¯æˆæ­£æ¯”çš„å–”ï¼',
        explanation: 'åœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14ã€‚å¦‚æœç›´å¾‘ Ã— 2ï¼Œåœ“å‘¨é•·ä¹Ÿæœƒè·Ÿè‘— Ã— 2ã€‚'
      },
      {
        q: 'åŠå¾‘ 5 å…¬åˆ†çš„åœ“ï¼Œåœ“å‘¨é•·æ˜¯å¤šå°‘ï¼Ÿ',
        options: ['15.7', '31.4', '10', '25'],
        ans: '31.4',
        hint: 'å…ˆæ±‚å‡ºç›´å¾‘ï¼Œç›´å¾‘æ˜¯åŠå¾‘çš„ 2 å€ã€‚',
        explanation: '1. å…ˆç®—ç›´å¾‘ï¼š5 Ã— 2 = 10 (å…¬åˆ†)\n2. å†ç®—åœ“å‘¨é•·ï¼š10 Ã— 3.14 = 31.4 (å…¬åˆ†)'
      }
    ]
  },
  {
    id: 'ocean',
    title: 'ç¬¬äºŒé—œï¼šå°‹æ‰¾ç›´å¾‘',
    desc: 'å·²çŸ¥åœ“å‘¨é•·ï¼Œä½ èƒ½æ¨ç®—å‡ºç›´å¾‘å—ï¼Ÿ',
    theme: 'ocean',
    learnSteps: [
      { text: "åœ¨æ·±è—æµ·æ´‹ä¸­ï¼Œæˆ‘å€‘è¦å­¸æœƒåå‘æ€è€ƒã€‚", highlight: "intro" },
      { text: "æ—¢ç„¶ã€Œåœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14ã€...", highlight: "recall" },
      { text: "é‚£å¦‚æœçŸ¥é“åœ“å‘¨é•·ï¼Œè¦æ€éº¼æ±‚ç›´å¾‘å‘¢ï¼Ÿ", highlight: "question" },
      { text: "æ²’éŒ¯ï¼å°±æ˜¯ã€Œç›´å¾‘ = åœ“å‘¨é•· Ã· 3.14ã€ã€‚", highlight: "formula" },
      { text: "ç¯„ä¾‹ï¼šåœ“å‘¨é•· 62.8ï¼Œç›´å¾‘å°±æ˜¯ 62.8 Ã· 3.14 = 20ã€‚", highlight: "example" }
    ],
    problems: [
      {
        q: 'ä¸€å€‹åœ“çš„åœ“å‘¨é•·æ˜¯ 62.8 å…¬åˆ†ï¼Œè«‹å•ç›´å¾‘æ˜¯å¤šå°‘å…¬åˆ†ï¼Ÿ',
        options: ['10', '20', '30', '40'],
        ans: '20',
        hint: 'ç›´å¾‘ = åœ“å‘¨é•· Ã· 3.14',
        explanation: 'åˆ©ç”¨é€†é‹ç®—ï¼š62.8 Ã· 3.14 = 20 (å…¬åˆ†)'
      },
      {
        q: 'åœ“å‘¨é•· 18.84 å…¬å°ºçš„åœ“å½¢èŠ±åœƒï¼ŒåŠå¾‘æ˜¯å¤šå°‘å…¬å°ºï¼Ÿ',
        options: ['3', '6', '9', '12'],
        ans: '3',
        hint: 'å…ˆç®—å‡ºç›´å¾‘ï¼Œå†é™¤ä»¥ 2 è®ŠæˆåŠå¾‘ã€‚',
        explanation: '1. ç›´å¾‘ï¼š18.84 Ã· 3.14 = 6 (å…¬å°º)\n2. åŠå¾‘ï¼š6 Ã· 2 = 3 (å…¬å°º)'
      },
      {
        q: 'æ¸¬è·è¼ªæ»¾ä¸€åœˆæ˜¯ 157 å…¬åˆ†ï¼Œé€™å€‹è¼ªå­çš„ç›´å¾‘ç´„æ˜¯å¤šå°‘ï¼Ÿ',
        options: ['25', '50', '100', '157'],
        ans: '50',
        hint: 'æ»¾ä¸€åœˆçš„é•·åº¦å°±æ˜¯åœ“å‘¨é•·ã€‚',
        explanation: '157 Ã· 3.14 = 50 (å…¬åˆ†)'
      }
    ]
  },
  {
    id: 'castle',
    title: 'ç¬¬ä¸‰é—œï¼šæ‰‡å½¢çš„ç¥•å¯†',
    desc: 'è¨ˆç®—æ‰‡å½¢çš„å¼§é•·èˆ‡å¹¾åˆ†ä¹‹å¹¾åœ“ã€‚',
    theme: 'castle',
    learnSteps: [
      { text: "ä¾†åˆ°å¹¾ä½•åŸå ¡ï¼Œæˆ‘å€‘è¦ç ”ç©¶ã€Œæ‰‡å½¢ã€ã€‚", highlight: "intro" },
      { text: "æ‰‡å½¢åœ“åœ“çš„é‚£æ®µæ›²ç·šï¼Œæˆ‘å€‘å«å®ƒã€Œå¼§é•·ã€ã€‚", highlight: "term" },
      { text: "å¼§é•·æ€éº¼ç®—ï¼Ÿå…¶å¯¦å°±æ˜¯ã€Œåœ“å‘¨é•· Ã— å¹¾åˆ†ä¹‹å¹¾åœ“ã€ã€‚", highlight: "formula" },
      { text: "å¦‚æœé¡Œç›®çµ¦è§’åº¦ï¼Œä¾‹å¦‚ 90 åº¦ï¼Œé‚£å°±æ˜¯ 90/360 = 1/4 åœ“ã€‚", highlight: "fraction" },
      { text: "ç¯„ä¾‹ï¼šç›´å¾‘ 20 çš„ 1/4 åœ“æ‰‡å½¢ï¼Œå¼§é•· = (20 Ã— 3.14) Ã— 1/4 = 15.7ã€‚", highlight: "example" }
    ],
    problems: [
      {
        q: 'åŠå¾‘ 10 å…¬åˆ†ï¼Œåœ“å¿ƒè§’ 180 åº¦çš„æ‰‡å½¢ï¼Œå¼§é•·æ˜¯å¤šå°‘ï¼Ÿ',
        options: ['31.4', '15.7', '62.8', '10'],
        ans: '31.4',
        hint: '180 åº¦æ˜¯åŠåœ“ (1/2 åœ“)ã€‚å…ˆç®—æ•´å€‹åœ“å‘¨é•·ï¼Œå†é™¤ä»¥ 2ã€‚',
        explanation: '1. ç›´å¾‘ï¼š10 Ã— 2 = 20\n2. åœ“å‘¨é•·ï¼š20 Ã— 3.14 = 62.8\n3. å¼§é•·ï¼š62.8 Ã— (180/360) = 31.4 (å…¬åˆ†)'
      },
      {
        q: 'åœ“å¿ƒè§’ 90 åº¦çš„æ‰‡å½¢ï¼Œæ˜¯å¹¾åˆ†ä¹‹å¹¾åœ“ï¼Ÿ',
        options: ['1/2', '1/3', '1/4', '1/6'],
        ans: '1/4',
        hint: '90 Ã· 360 = ?',
        explanation: '90/360ï¼Œç´„åˆ†å¾Œç­‰æ–¼ 1/4ã€‚'
      },
      {
        q: 'ç›´å¾‘ 20 å…¬åˆ†ï¼Œ1/4 åœ“çš„æ‰‡å½¢ï¼Œå¼§é•·æ˜¯å¤šå°‘ï¼Ÿ',
        options: ['15.7', '31.4', '78.5', '5'],
        ans: '15.7',
        hint: 'åœ“å‘¨é•· Ã— 1/4',
        explanation: '1. åœ“å‘¨é•·ï¼š20 Ã— 3.14 = 62.8\n2. å¼§é•·ï¼š62.8 Ã— 1/4 = 15.7 (å…¬åˆ†)'
      }
    ]
  },
  {
    id: 'space',
    title: 'ç¬¬å››é—œï¼šæ‰‡å½¢å‘¨é•·å¤§æŒ‘æˆ°',
    desc: 'å°å¿ƒï¼æ‰‡å½¢å‘¨é•·ä¸åªæœ‰å¼§é•·å–”ï¼',
    theme: 'space',
    learnSteps: [
      { text: "åœ¨å¤ªç©ºè¦ç‰¹åˆ¥å°å¿ƒé™·é˜±ï¼é¡Œç›®å•ã€Œæ‰‡å½¢å‘¨é•·ã€æ™‚...", highlight: "intro" },
      { text: "å‘¨é•· = ç¹ä¸€åœˆçš„é•·åº¦ã€‚", highlight: "concept" },
      { text: "æ‰€ä»¥é™¤äº†ã€Œå¼§é•·ã€ï¼Œé‚„è¦åŠ ä¸Šå…©é‚Šçš„ç›´ç·šï¼Œä¹Ÿå°±æ˜¯ã€Œå…©æ¢åŠå¾‘ã€ï¼", highlight: "warning" },
      { text: "å…¬å¼ï¼šæ‰‡å½¢å‘¨é•· = å¼§é•· + åŠå¾‘ Ã— 2", highlight: "formula" },
      { text: "è¨˜å¾—å–”ï¼Œç¼ºä¸€ä¸å¯ï¼", highlight: "final" }
    ],
    problems: [
      {
        q: 'åŠå¾‘ 10 å…¬åˆ†çš„åŠåœ“å½¢ (1/2åœ“)ï¼Œå®ƒçš„å‘¨é•·æ˜¯å¤šå°‘ï¼Ÿ',
        options: ['31.4', '51.4', '41.4', '62.8'],
        ans: '51.4',
        hint: 'å‘¨é•· = å¼§é•· + ç›´å¾‘ (å…©æ¢åŠå¾‘)',
        explanation: '1. ç›´å¾‘ = 20\n2. å¼§é•· = 20 Ã— 3.14 Ã· 2 = 31.4\n3. å‘¨é•· = 31.4 + 20 = 51.4 (å…¬åˆ†)'
      },
      {
        q: 'ä¸€å€‹ 1/4 åœ“çš„æ‰‡å½¢ï¼ŒåŠå¾‘ 4 å…¬åˆ†ï¼Œå‘¨é•·æ˜¯å¤šå°‘ï¼Ÿ',
        options: ['6.28', '10.28', '14.28', '12.56'],
        ans: '14.28',
        hint: 'åˆ¥å¿˜äº†åŠ ä¸Šå…©æ¢åŠå¾‘ï¼',
        explanation: '1. ç›´å¾‘ = 8\n2. å¼§é•· = 8 Ã— 3.14 Ã— 1/4 = 6.28\n3. å‘¨é•· = 6.28 + 4 + 4 = 14.28 (å…¬åˆ†)'
      }
    ]
  },
  {
    id: 'magic',
    title: 'ç¬¬äº”é—œï¼šçµ‚æ¥µæ‡‰ç”¨',
    desc: 'è¤‡åˆåœ–å½¢çš„å‘¨é•·è¨ˆç®—ï¼',
    theme: 'magic',
    learnSteps: [
      { text: "æœ€å¾Œæ˜¯é­”æ³•å­¸é™¢çš„è€ƒé©—ï¼Œé€™è£¡çš„åœ–å½¢å¾ˆç‰¹åˆ¥ã€‚", highlight: "intro" },
      { text: "é‡åˆ°å½¢ç‹€å¥‡æ€ªçš„è·‘é“æˆ–è¤‡åˆåœ–å½¢ï¼Œå…ˆæŠŠå®ƒã€Œæ‹†è§£ã€ã€‚", highlight: "strategy" },
      { text: "é€šå¸¸æ˜¯ï¼šç›´ç·šéƒ¨åˆ† + æ›²ç·šéƒ¨åˆ†ã€‚", highlight: "concept" },
      { text: "ä¾‹å¦‚æ“å ´è·‘é“ï¼šå°±æ˜¯ã€Œå…©æ¢ç›´ç·šé•·ã€ + ã€Œä¸€å€‹å®Œæ•´çš„åœ“å‘¨é•·ã€ã€‚", highlight: "example" },
      { text: "æŠŠåœ–å½¢çœ‹æ‡‚ï¼Œè¨ˆç®—å°±å¾ˆç°¡å–®å›‰ï¼", highlight: "cheer" }
    ],
    problems: [
      {
        q: 'ä¸€å€‹æ“å ´è·‘é“ç”±ä¸€å€‹é•·æ–¹å½¢å’Œå…©å€‹åŠåœ“çµ„æˆï¼Œå¦‚æœè¦ç®—è·‘ä¸€åœˆçš„é•·åº¦ï¼Œéœ€è¦åŠ ä»€éº¼ï¼Ÿ',
        options: ['å…©å€‹é•·é‚Š + ä¸€å€‹åœ“å‘¨é•·', 'å…©å€‹å¯¬é‚Š + å…©å€‹åœ“å‘¨é•·', 'é•·æ–¹å½¢å‘¨é•· + åœ“å‘¨é•·', 'åªæœ‰å…©å€‹é•·é‚Š'],
        ans: 'å…©å€‹é•·é‚Š + ä¸€å€‹åœ“å‘¨é•·',
        hint: 'æŠŠå…©å€‹åŠåœ“æ‹¼èµ·ä¾†å°±æ˜¯ä¸€å€‹åœ“ã€‚',
        explanation: 'è·‘é“çš„ä¸€åœˆé€šå¸¸åŒ…å«å…©æ¢ç›´ç·šè·‘é“ (é•·æ–¹å½¢çš„é•·é‚Š) å’Œå…©å€‹å½é“ (åˆèµ·ä¾†æ˜¯ä¸€å€‹åœ“å‘¨)ã€‚å…§éƒ¨å¯¬åº¦ä¸éœ€è¦è·‘ã€‚'
      },
      {
        q: 'è§€å¯Ÿåœ–å½¢ï¼šå››å€‹ 1/4 åœ“çš„å¼§é•·åˆèµ·ä¾†ï¼Œç­‰æ–¼ä»€éº¼ï¼Ÿ(å‡è¨­åŠå¾‘ç›¸åŒ)',
        options: ['1 å€‹åœ“å‘¨é•·', '2 å€‹åœ“å‘¨é•·', 'åŠå€‹åœ“å‘¨é•·', '4 å€‹åœ“å‘¨é•·'],
        ans: '1 å€‹åœ“å‘¨é•·',
        hint: '1/4 + 1/4 + 1/4 + 1/4 = 1',
        explanation: 'å››å€‹ 1/4 åœ“åˆèµ·ä¾†å‰›å¥½æ˜¯ä¸€å€‹å®Œæ•´çš„åœ“ï¼Œæ‰€ä»¥å¼§é•·ç¸½å’Œç­‰æ–¼ä¸€å€‹åœ“å‘¨é•·ã€‚'
      }
    ]
  }
];

// --- å­¸ç¿’å…§å®¹ (Review Content) ---
const LEARNING_CONTENT = [
  {
    title: 'èªè­˜åœ“å‘¨ç‡ (Ï€)',
    content: (
      <div className="space-y-4">
        <div className="flex justify-center">
          <div className="relative w-32 h-32 border-4 border-blue-500 rounded-full flex items-center justify-center">
            <div className="absolute w-full h-0.5 bg-red-500 top-1/2 transform -translate-y-1/2"></div>
            <span className="text-red-500 font-bold bg-white px-1 relative -top-4">ç›´å¾‘</span>
            <span className="absolute -right-16 text-blue-600 font-bold">åœ“å‘¨é•·</span>
          </div>
        </div>
        <p>ä¸ç®¡åœ“æ˜¯å¤§æ˜¯å°ï¼Œ<strong>åœ“å‘¨é•· Ã· ç›´å¾‘</strong> æ°¸é éƒ½å¤§ç´„ç­‰æ–¼ <strong>3.14</strong>ã€‚</p>
        <p>é€™å€‹ç¥ç¥•çš„æ•¸å­—æˆ‘å€‘å«å®ƒã€Œåœ“å‘¨ç‡ã€ã€‚</p>
        <div className="bg-yellow-100 p-4 rounded-lg text-center font-bold text-xl text-yellow-800">
          åœ“å‘¨é•· = ç›´å¾‘ Ã— 3.14
        </div>
      </div>
    )
  },
  {
    title: 'æ‰‡å½¢çš„å¼§é•·',
    content: (
      <div className="space-y-4">
        <div className="flex justify-center">
          <div className="w-32 h-32 bg-green-200 rounded-full relative overflow-hidden">
            <div className="absolute w-32 h-32 bg-green-500 origin-bottom-left transform rotate-90 bottom-0 left-0"></div>
          </div>
        </div>
        <p>æ‰‡å½¢æ˜¯åœ“çš„ä¸€éƒ¨åˆ†ã€‚æ‰‡å½¢åœ“å¼§éƒ¨åˆ†çš„é•·åº¦å«ä½œ<strong>ã€Œå¼§é•·ã€</strong>ã€‚</p>
        <p>è¨ˆç®—æ–¹æ³•ï¼šå…ˆç®—å‡ºæ•´å€‹åœ“å‘¨é•·ï¼Œå†çœ‹æ‰‡å½¢ä½”äº†åœ“çš„å¹¾åˆ†ä¹‹å¹¾ã€‚</p>
        <div className="bg-green-100 p-4 rounded-lg text-sm text-green-800 space-y-2">
          <p>æ­¥é©Ÿ 1ï¼šç›´å¾‘ Ã— 3.14 (ç®—åœ“å‘¨é•·)</p>
          <p>æ­¥é©Ÿ 2ï¼šåœ“å‘¨é•· Ã— (åœ“å¿ƒè§’ Ã· 360)</p>
        </div>
      </div>
    )
  },
  {
    title: 'æ‰‡å½¢çš„å‘¨é•·',
    content: (
      <div className="space-y-4">
        <p className="text-red-500 font-bold">é€™é¡Œæœ€å®¹æ˜“éŒ¯ï¼</p>
        <p>é¡Œç›®å•ã€Œæ‰‡å½¢çš„å‘¨é•·ã€æ™‚ï¼Œä¸åªè¦ç®—å¼§é•·ï¼Œé‚„è¦åŠ ä¸Š<strong>å…©æ¢åŠå¾‘</strong>ï¼</p>
        <div className="flex justify-center items-center space-x-2">
          <div className="w-16 h-16 border-t-4 border-r-4 border-blue-500 rounded-tr-full"></div>
          <span className="text-2xl">+</span>
          <div className="w-16 h-0.5 bg-red-500 relative"><span className="absolute -top-6">åŠå¾‘</span></div>
          <span className="text-2xl">+</span>
          <div className="w-16 h-0.5 bg-red-500 relative"><span className="absolute -top-6">åŠå¾‘</span></div>
        </div>
        <div className="bg-purple-100 p-4 rounded-lg text-center font-bold text-purple-800">
          æ‰‡å½¢å‘¨é•· = å¼§é•· + åŠå¾‘ Ã— 2
        </div>
      </div>
    )
  }
];

// --- ç‘èŠ±ç‰¹æ•ˆå…ƒä»¶ ---
const Confetti = () => {
  const [particles, setParticles] = useState([]);

  useEffect(() => {
    // ç”¢ç”Ÿ 50 ç‰‡å½©å¸¶
    const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
    const newParticles = Array.from({ length: 50 }).map((_, i) => ({
      id: i,
      x: Math.random() * 100, // 0-100%
      y: -20 - Math.random() * 50, // Start above screen
      color: colors[Math.floor(Math.random() * colors.length)],
      size: 5 + Math.random() * 10,
      rotation: Math.random() * 360,
      speed: 2 + Math.random() * 3,
      delay: Math.random() * 2,
    }));
    setParticles(newParticles);
  }, []);

  return (
    <div className="fixed inset-0 pointer-events-none z-50 overflow-hidden">
      {particles.map((p) => (
        <div
          key={p.id}
          className="absolute animate-fall"
          style={{
            left: `${p.x}%`,
            top: `${p.y}%`,
            width: `${p.size}px`,
            height: `${p.size}px`,
            backgroundColor: p.color,
            transform: `rotate(${p.rotation}deg)`,
            animationName: 'fall',
            animationDuration: `${p.speed}s`,
            animationDelay: `${p.delay}s`,
            animationIterationCount: 'infinite',
            animationTimingFunction: 'linear'
          }}
        />
      ))}
      <style>{`
        @keyframes fall {
          0% { top: -10%; transform: rotate(0deg); opacity: 1; }
          100% { top: 110%; transform: rotate(360deg); opacity: 0; }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0px) rotate(0deg); }
          50% { transform: translateY(-20px) rotate(5deg); }
        }
      `}</style>
    </div>
  );
};

// --- éŸ³æ•ˆç®¡ç†å™¨ (Web Audio API) ---
const useSoundEffects = () => {
  const playTone = useCallback((freq, type, duration, delay = 0) => {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (!AudioContext) return;
    const ctx = new AudioContext();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();

    osc.type = type;
    osc.frequency.setValueAtTime(freq, ctx.currentTime + delay);
    
    gain.gain.setValueAtTime(0.1, ctx.currentTime + delay);
    gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + delay + duration);

    osc.connect(gain);
    gain.connect(ctx.destination);

    osc.start(ctx.currentTime + delay);
    osc.stop(ctx.currentTime + delay + duration);
  }, []);

  const playCorrect = useCallback(() => {
    playTone(880, 'sine', 0.1); // Ding
    playTone(1760, 'sine', 0.3, 0.1); // Dong
  }, [playTone]);

  const playWrong = useCallback(() => {
    playTone(150, 'sawtooth', 0.3);
  }, [playTone]);

  const playFanfare = useCallback(() => {
    // C Major Arpeggio: C E G C
    const now = 0;
    playTone(523.25, 'triangle', 0.2, now);       // C5
    playTone(659.25, 'triangle', 0.2, now + 0.15); // E5
    playTone(783.99, 'triangle', 0.2, now + 0.3);  // G5
    playTone(1046.50, 'square', 0.6, now + 0.45);  // C6
  }, [playTone]);

  return { playCorrect, playWrong, playFanfare };
};

// --- å…ƒä»¶: éŒ„éŸ³æ©Ÿ (å…§éƒ¨) ---
const AudioRecorder = () => {
  const [isRecording, setIsRecording] = useState(false);
  const [audioUrl, setAudioUrl] = useState(null);
  const mediaRecorderRef = useRef(null);
  const audioChunksRef = useRef([]);

  const startRecording = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorderRef.current = new MediaRecorder(stream);
      audioChunksRef.current = [];

      mediaRecorderRef.current.ondataavailable = (event) => {
        if (event.data.size > 0) {
          audioChunksRef.current.push(event.data);
        }
      };

      mediaRecorderRef.current.onstop = () => {
        const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/wav' });
        const url = URL.createObjectURL(audioBlob);
        setAudioUrl(url);
      };

      mediaRecorderRef.current.start();
      setIsRecording(true);
      setAudioUrl(null); // Clear previous recording
    } catch (err) {
      console.error("Error accessing microphone:", err);
      alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ï¼Œè«‹ç¢ºèªç€è¦½å™¨æ¬Šé™è¨­å®šã€‚");
    }
  };

  const stopRecording = () => {
    if (mediaRecorderRef.current && isRecording) {
      mediaRecorderRef.current.stop();
      setIsRecording(false);
      // Stop all tracks to release microphone
      if (mediaRecorderRef.current.stream) {
          mediaRecorderRef.current.stream.getTracks().forEach(track => track.stop());
      }
    }
  };

  return (
    <div className="w-full bg-slate-50 border-2 border-slate-200 rounded-2xl p-4 mt-6 flex flex-col items-center">
        <h4 className="text-slate-500 font-bold mb-3 flex items-center">
            <Mic className="w-4 h-4 mr-1" /> æˆ‘çš„å£èªªç­†è¨˜
        </h4>
        
        <div className="flex items-center space-x-4">
            {!isRecording ? (
                <button 
                    onClick={startRecording}
                    className="flex items-center bg-red-500 text-white px-4 py-2 rounded-full font-bold hover:bg-red-600 transition shadow-sm"
                >
                    <Mic className="w-5 h-5 mr-2" /> é–‹å§‹éŒ„éŸ³
                </button>
            ) : (
                <button 
                    onClick={stopRecording}
                    className="flex items-center bg-slate-700 text-white px-4 py-2 rounded-full font-bold hover:bg-slate-800 transition shadow-sm animate-pulse"
                >
                    <Square className="w-5 h-5 mr-2 fill-current" /> åœæ­¢éŒ„éŸ³
                </button>
            )}

            {audioUrl && !isRecording && (
                <div className="flex items-center space-x-2 animate-fade-in">
                    <audio src={audioUrl} controls className="h-10 w-48" />
                    <button 
                        onClick={() => setAudioUrl(null)}
                        className="p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-200 tooltip"
                        title="é‡æ–°éŒ„éŸ³"
                    >
                        <RotateCcw className="w-5 h-5" />
                    </button>
                </div>
            )}
        </div>
        {isRecording && <p className="text-red-500 text-sm mt-2 font-medium animate-pulse">æ­£åœ¨éŒ„éŸ³ä¸­...è«‹èªªå‡ºä½ çš„é‡é»ï¼</p>}
        {!isRecording && !audioUrl && <p className="text-slate-400 text-xs mt-2">è©¦è‘—ç”¨è‡ªå·±çš„è©±èªªèªªçœ‹ï¼ŒéŒ„ä¸‹ä¾†è½è½çœ‹ï¼</p>}
    </div>
  );
};

// --- å…ƒä»¶: ä¸»é¸å–® ---
const MainMenu = ({ onSelectMode }) => (
  <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4 relative overflow-hidden">
    {/* è£é£¾èƒŒæ™¯ */}
    <div className="absolute top-10 left-10 text-white/60 animate-bounce delay-1000 drop-shadow-lg font-bold text-8xl md:text-9xl pointer-events-none">Ï€</div>
    <div className="absolute bottom-10 right-10 text-white/60 animate-pulse drop-shadow-lg font-bold text-8xl md:text-9xl pointer-events-none">3.14</div>
    
    <div className="absolute top-20 right-20 text-white/50 drop-shadow-xl pointer-events-none" style={{ animation: 'float 6s ease-in-out infinite' }}>
        <PieChart size={180} />
    </div>

    <div className="absolute bottom-32 left-20 text-white/50 flex flex-col items-center drop-shadow-xl pointer-events-none" style={{ animation: 'float 7s ease-in-out infinite reverse' }}>
        <Circle size={140} />
        <Ruler size={120} className="mt-2" />
    </div>

    <div className="absolute top-1/3 left-10 text-white/40 rotate-45 drop-shadow-lg pointer-events-none" style={{ animation: 'float 5s ease-in-out infinite 1s' }}>
        <Scissors size={100} />
    </div>
    <div className="absolute bottom-1/3 right-10 text-white/40 -rotate-12 drop-shadow-lg pointer-events-none" style={{ animation: 'float 8s ease-in-out infinite' }}>
        <Shapes size={120} />
    </div>

    <div className="bg-white/95 backdrop-blur-sm p-8 md:p-12 rounded-3xl shadow-2xl max-w-lg w-full text-center space-y-8 border-8 border-yellow-400 relative z-10 transform transition-all hover:scale-[1.01]">
        <div className="relative">
            <div className="absolute -top-16 left-1/2 transform -translate-x-1/2 bg-yellow-400 p-4 rounded-full shadow-lg border-4 border-white">
                <Trophy size={48} className="text-white" />
            </div>
            <h1 className="text-4xl md:text-5xl font-black text-indigo-600 mb-2 tracking-wider mt-6 drop-shadow-sm">
                æ•¸å­¸å†’éšªç‹
            </h1>
            <div className="inline-block bg-indigo-100 text-indigo-600 px-4 py-1 rounded-full text-sm font-bold mb-2">
                L7. åœ“å‘¨é•·èˆ‡æ‰‡å½¢å‘¨é•·
            </div>
            <p className="text-gray-500 text-lg">æº–å‚™å¥½å±•é–‹ä½ çš„æ•¸å­¸å†’éšªäº†å—ï¼Ÿ</p>
        </div>
        
        <div className="grid gap-6">
            <button 
                onClick={() => onSelectMode('review')} 
                className="group relative flex items-center p-5 bg-gradient-to-r from-orange-400 to-orange-500 hover:from-orange-500 hover:to-orange-600 text-white rounded-2xl shadow-lg transition-all transform hover:-translate-y-1 hover:shadow-2xl border-b-4 border-orange-700 active:border-b-0 active:translate-y-1"
            >
                <div className="bg-white/20 p-3 rounded-xl mr-5 group-hover:rotate-12 transition-transform">
                    <BookOpen size={32} />
                </div>
                <div className="text-left flex-1">
                    <div className="font-black text-xl mb-1">é‡é»ç¥•ç¬ˆ</div>
                    <div className="text-sm text-orange-100 font-medium">è¤‡ç¿’åœ“å‘¨ç‡èˆ‡å…¬å¼</div>
                </div>
                <ChevronRight size={24} className="opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
            </button>
            
            <button 
                onClick={() => onSelectMode('learn')} 
                className="group relative flex items-center p-5 bg-gradient-to-r from-green-400 to-green-500 hover:from-green-500 hover:to-green-600 text-white rounded-2xl shadow-lg transition-all transform hover:-translate-y-1 hover:shadow-2xl border-b-4 border-green-700 active:border-b-0 active:translate-y-1"
            >
                <div className="bg-white/20 p-3 rounded-xl mr-5 group-hover:rotate-12 transition-transform">
                    <GraduationCap size={32} />
                </div>
                <div className="text-left flex-1">
                    <div className="font-black text-xl mb-1">äº’å‹•æ•™å­¸</div>
                    <div className="text-sm text-green-100 font-medium">è·Ÿè‘—æ­¥é©Ÿä¸€æ­¥æ­¥å­¸</div>
                </div>
                <ChevronRight size={24} className="opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
            </button>

            <button 
                onClick={() => onSelectMode('game')} 
                className="group relative flex items-center p-5 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-2xl shadow-lg transition-all transform hover:-translate-y-1 hover:shadow-2xl border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1"
            >
                <div className="bg-white/20 p-3 rounded-xl mr-5 group-hover:rotate-12 transition-transform">
                    <Map size={32} />
                </div>
                <div className="text-left flex-1">
                    <div className="font-black text-xl mb-1">å†’éšªé—–é—œ</div>
                    <div className="text-sm text-indigo-100 font-medium">æŒ‘æˆ°äº”å¤§é—œå¡è´è­‰æ›¸</div>
                </div>
                <ChevronRight size={24} className="opacity-50 group-hover:opacity-100 group-hover:translate-x-1 transition-all" />
                
                <div className="absolute -top-3 -right-3 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full animate-bounce shadow-md">
                    HOT!
                </div>
            </button>
        </div>
        
        <div className="text-gray-400 text-sm font-medium pt-4 border-t border-gray-100">
            é©åˆåœ‹å°å…­å¹´ç´š â€¢ æ•¸å­¸å–®å…ƒ
        </div>
    </div>
  </div>
);

// --- å…ƒä»¶: é‡é»è¤‡ç¿’æ¨¡å¼ ---
const ReviewMode = ({ onBack }) => {
  const [page, setPage] = useState(0);

  return (
    <div className="min-h-screen bg-orange-50 p-4 flex flex-col items-center justify-center">
      <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden min-h-[600px] flex flex-col relative">
        <div className="bg-orange-400 p-4 text-white flex items-center justify-between">
          <button onClick={onBack} className="p-2 hover:bg-white/20 rounded-full"><Home size={24} /></button>
          <h2 className="text-2xl font-bold">é‡é»ç¥•ç¬ˆ</h2>
          <div className="w-8"></div>
        </div>

        <div className="flex-1 p-8 flex flex-col items-center justify-center text-center">
          <h3 className="text-3xl font-bold text-gray-800 mb-8">{LEARNING_CONTENT[page].title}</h3>
          <div className="text-xl text-gray-600 leading-relaxed w-full">
            {LEARNING_CONTENT[page].content}
          </div>
        </div>

        <div className="p-6 bg-gray-50 flex justify-between items-center border-t">
          <button 
            onClick={() => setPage(Math.max(0, page - 1))}
            disabled={page === 0}
            className={`flex items-center px-4 py-2 rounded-lg font-bold ${page === 0 ? 'bg-gray-200 text-gray-400' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'}`}
          >
            ä¸Šä¸€é 
          </button>
          <span className="font-bold text-gray-400">{page + 1} / {LEARNING_CONTENT.length}</span>
          <button 
            onClick={() => setPage(Math.min(LEARNING_CONTENT.length - 1, page + 1))}
            disabled={page === LEARNING_CONTENT.length - 1}
            className={`flex items-center px-4 py-2 rounded-lg font-bold ${page === LEARNING_CONTENT.length - 1 ? 'bg-gray-200 text-gray-400' : 'bg-orange-100 text-orange-600 hover:bg-orange-200'}`}
          >
            ä¸‹ä¸€é 
          </button>
        </div>
      </div>
    </div>
  );
};

// --- å…ƒä»¶: äº’å‹•å­¸ç¿’ (é¸æ“‡å–®å…ƒ -> è©²å–®å…ƒæ•™å­¸) ---
const LearnMode = ({ onBack }) => {
  const [selectedLevelId, setSelectedLevelId] = useState(null);
  const [step, setStep] = useState(0);

  const selectedLevel = LEVELS.find(l => l.id === selectedLevelId);

  // å¦‚æœé‚„æ²’é¸å–®å…ƒï¼Œé¡¯ç¤ºå–®å…ƒé¸æ“‡æ¸…å–®
  if (!selectedLevelId) {
    return (
      <div className="min-h-screen bg-green-50 p-4 flex flex-col items-center justify-center">
        <div className="w-full max-w-5xl">
          <div className="flex items-center justify-between mb-8">
            <button onClick={onBack} className="bg-white p-2 rounded-full shadow hover:bg-gray-50"><Home size={28}/></button>
            <h2 className="text-3xl font-extrabold text-green-700">é¸æ“‡å­¸ç¿’æ¦‚å¿µ</h2>
            <div className="w-10"></div>
          </div>

          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {LEVELS.map((level) => {
              const ThemeIcon = THEMES[level.theme].icon;
              return (
                <button
                  key={level.id}
                  onClick={() => { setSelectedLevelId(level.id); setStep(0); }}
                  className="relative p-6 rounded-2xl shadow-lg transition-all text-left group bg-white hover:-translate-y-2 hover:shadow-xl border-l-8 border-green-400 h-full flex flex-col justify-between"
                >
                  <div>
                    <div className={`absolute top-4 right-4 p-2 rounded-full ${THEMES[level.theme].color}`}>
                        <ThemeIcon className={`w-6 h-6 ${THEMES[level.theme].accent}`} />
                    </div>
                    <h3 className="text-xl font-bold mb-2 text-gray-800 pr-10">{level.title}</h3>
                    <p className="text-sm text-gray-500 mb-4">{level.desc}</p>
                  </div>
                  <div className="flex items-center text-green-600 font-bold mt-auto">
                    é–‹å§‹å­¸ç¿’ <ArrowRight className="w-5 h-5 ml-2" />
                  </div>
                </button>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  // é€²å…¥å–®å…ƒæ•™å­¸
  const steps = selectedLevel.learnSteps || [{ text: "æœ¬å–®å…ƒæ•™å­¸å…§å®¹å»ºç½®ä¸­...", highlight: "none" }];
  const currentStepData = steps[step];
  const ThemeIcon = THEMES[selectedLevel.theme].icon;

  return (
    <div className={`min-h-screen ${THEMES[selectedLevel.theme].color} p-4 flex flex-col items-center justify-center`}>
      <div className="bg-white p-8 rounded-3xl shadow-xl max-w-4xl w-full relative overflow-hidden flex flex-col min-h-[600px]">
        {/* èƒŒæ™¯è£é£¾ */}
        <ThemeIcon className={`absolute -top-10 -right-10 w-48 h-48 opacity-10 ${THEMES[selectedLevel.theme].accent}`} />

        <div className="flex justify-between items-center mb-6 relative z-10">
          <div className="flex items-center">
            <div className={`p-2 rounded-full mr-3 ${THEMES[selectedLevel.theme].color}`}>
              <ThemeIcon className={`w-6 h-6 ${THEMES[selectedLevel.theme].accent}`} />
            </div>
            <h2 className="text-xl md:text-2xl font-bold text-gray-700">{selectedLevel.title}</h2>
          </div>
          <button onClick={() => setSelectedLevelId(null)} className="text-gray-400 hover:text-gray-600"><XCircle size={28}/></button>
        </div>
        
        {/* é¡¯ç¤ºæ•™å­¸æ–‡å­— */}
        <div className="flex-1 flex flex-col items-center text-center relative z-10 justify-center">
           <div className={`flex items-center justify-center text-2xl md:text-3xl font-medium leading-relaxed px-4 py-6 mb-6 w-full
             ${currentStepData.highlight === 'formula' ? 'text-blue-600 font-bold bg-blue-50 rounded-xl border-2 border-blue-100 shadow-sm' : 
               currentStepData.highlight === 'term' ? 'text-purple-600 font-bold' : 
               currentStepData.highlight === 'warning' ? 'text-red-600 font-bold' : 'text-gray-700'}
           `}>
             {currentStepData.text}
           </div>

            {/* éŒ„éŸ³åŠŸèƒ½ - æ”¾åœ¨å…§å®¹ä¸‹æ–¹ï¼Œä½œç‚ºäº’å‹•ç­†è¨˜ */}
           <AudioRecorder />
           
           {/* æ­¥é©ŸæŒ‡ç¤ºå™¨ */}
           <div className="mt-8 mb-4 flex space-x-2">
             {steps.map((_, i) => (
               <div key={i} className={`h-2 rounded-full transition-all duration-300 ${i === step ? `w-8 ${THEMES[selectedLevel.theme].button.split(' ')[0]}` : 'w-2 bg-gray-200'}`}></div>
             ))}
           </div>
        </div>

        <div className="flex justify-between items-center relative z-10 pt-4 border-t border-gray-100">
          <button 
            onClick={() => setStep(Math.max(0, step - 1))}
            disabled={step === 0}
            className={`px-6 py-3 rounded-xl font-bold transition ${step === 0 ? 'opacity-0 cursor-default' : 'bg-gray-100 text-gray-500 hover:bg-gray-200'}`}
          >
            ä¸Šä¸€æ­¥
          </button>

          {step < steps.length - 1 ? (
            <button onClick={() => setStep(step + 1)} className={`${THEMES[selectedLevel.theme].button} text-white px-8 py-3 rounded-xl text-lg font-bold shadow-lg flex items-center animate-bounce`}>
              ä¸‹ä¸€æ­¥ <ArrowRight className="ml-2" />
            </button>
          ) : (
             <button onClick={() => setSelectedLevelId(null)} className="bg-gray-800 text-white px-8 py-3 rounded-xl text-lg font-bold hover:bg-black shadow-lg flex items-center">
              å®Œæˆæ•™å­¸ <CheckCircle className="ml-2" />
            </button>
          )}
        </div>
      </div>
    </div>
  );
};

// --- å…ƒä»¶: éŠæˆ²æ¨¡å¼ (æ ¸å¿ƒåŠŸèƒ½) ---
const GameMode = ({ onBack }) => {
  const [gameState, setGameState] = useState('levelSelect'); // levelSelect, playing, summary, certificate
  const [currentLevelId, setCurrentLevelId] = useState(null);
  const [currentProblemIndex, setCurrentProblemIndex] = useState(0);
  const [hp, setHp] = useState(3);
  const [score, setScore] = useState(0);
  const [showExplanation, setShowExplanation] = useState(false);
  const [completedLevels, setCompletedLevels] = useState([]);
  const [userName, setUserName] = useState('');
  const [showHint, setShowHint] = useState(false);
  const [feedback, setFeedback] = useState(null); // 'correct', 'wrong'
  
  // å¼•å…¥éŸ³æ•ˆ Hook
  const { playCorrect, playWrong, playFanfare } = useSoundEffects();

  const currentLevel = LEVELS.find(l => l.id === currentLevelId);
  const currentProblem = currentLevel ? currentLevel.problems[currentProblemIndex] : null;
  const theme = currentLevel ? THEMES[currentLevel.theme] : THEMES.forest;

  const startLevel = (levelId) => {
    setCurrentLevelId(levelId);
    setGameState('playing');
    setCurrentProblemIndex(0);
    setHp(3);
    setShowExplanation(false);
    setShowHint(false);
    setFeedback(null);
  };

  const handleAnswer = (option) => {
    if (showExplanation) return; // Prevent clicking during explanation

    if (option === currentProblem.ans) {
      setFeedback('correct');
      playCorrect(); // æ’­æ”¾æ­£ç¢ºéŸ³æ•ˆ
      setScore(score + 100);
      setTimeout(() => {
        nextProblem();
      }, 1500);
    } else {
      setFeedback('wrong');
      playWrong(); // æ’­æ”¾éŒ¯èª¤éŸ³æ•ˆ (é›–ç„¶ç›®å‰ playWrong å¯¦ä½œæ¯”è¼ƒç°¡å–®)
      setHp(prev => prev - 1);
      setShowExplanation(true);
      // Wait for user to click "Next" manually if wrong, so they can read explanation
    }
  };

  const nextProblem = () => {
    setFeedback(null);
    setShowExplanation(false);
    setShowHint(false);
    
    if (hp <= 0 && feedback !== 'correct') { 
        setGameState('summary');
        return;
    }

    if (currentProblemIndex < currentLevel.problems.length - 1) {
      setCurrentProblemIndex(prev => prev + 1);
    } else {
      // Level Completed
      if (!completedLevels.includes(currentLevelId)) {
        setCompletedLevels([...completedLevels, currentLevelId]);
      }
      playFanfare(); // æ’­æ”¾éé—œéŸ³æ¨‚
      setGameState('summary');
    }
  };

  // --- å­ç•«é¢: é—œå¡é¸æ“‡ ---
  if (gameState === 'levelSelect') {
    return (
      <div className="min-h-screen bg-slate-100 p-4 flex flex-col items-center justify-center">
        <div className="w-full max-w-5xl">
          <div className="flex items-center justify-between mb-8">
            <button onClick={onBack} className="bg-white p-2 rounded-full shadow hover:bg-gray-50"><Home size={28}/></button>
            <h2 className="text-3xl font-extrabold text-slate-700">é¸æ“‡å†’éšªé—œå¡</h2>
            <div className="bg-yellow-400 px-4 py-2 rounded-full font-bold text-yellow-900 shadow flex items-center">
              <Star className="w-5 h-5 mr-1 fill-current" /> åˆ†æ•¸: {score}
            </div>
          </div>

          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {LEVELS.map((level, idx) => {
              const ThemeIcon = THEMES[level.theme].icon;
              const isLocked = idx > 0 && !completedLevels.includes(LEVELS[idx-1].id);
              const isCompleted = completedLevels.includes(level.id);

              return (
                <button
                  key={level.id}
                  onClick={() => !isLocked && startLevel(level.id)}
                  disabled={isLocked}
                  className={`relative p-6 rounded-2xl shadow-lg transition-all text-left group h-full flex flex-col justify-between
                    ${isLocked ? 'bg-gray-200 cursor-not-allowed opacity-70' : 'bg-white hover:-translate-y-2 hover:shadow-xl'}
                  `}
                >
                  <div>
                    <div className={`absolute top-4 right-4 p-2 rounded-full ${THEMES[level.theme].color}`}>
                        <ThemeIcon className={`w-6 h-6 ${THEMES[level.theme].accent}`} />
                    </div>
                    <h3 className="text-xl font-bold mb-2 text-gray-800 pr-10">{level.title}</h3>
                    <p className="text-sm text-gray-500 mb-4">{level.desc}</p>
                  </div>
                  
                  {isCompleted ? (
                     <div className="flex items-center text-green-500 font-bold mt-auto"><CheckCircle className="w-5 h-5 mr-1" /> å·²å®Œæˆ</div>
                  ) : isLocked ? (
                     <div className="flex items-center text-gray-400 font-bold mt-auto"><Award className="w-5 h-5 mr-1" /> è«‹å…ˆå®Œæˆä¸Šä¸€é—œ</div>
                  ) : (
                     <div className={`inline-block px-4 py-2 rounded-lg text-white text-sm font-bold mt-auto ${THEMES[level.theme].button}`}>
                       é–‹å§‹æŒ‘æˆ°
                     </div>
                  )}
                </button>
              );
            })}
          </div>

          {completedLevels.length === LEVELS.length && (
            <div className="mt-12 text-center">
              <button 
                onClick={() => setGameState('certificate')}
                className="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-12 py-6 rounded-full text-2xl font-bold shadow-2xl animate-pulse transform hover:scale-105"
              >
                é ˜å–æ¦®è­½è­‰æ›¸ ğŸ†
              </button>
            </div>
          )}
        </div>
      </div>
    );
  }

  // --- å­ç•«é¢: éŠæˆ²é€²è¡Œä¸­ ---
  if (gameState === 'playing') {
    if (hp <= 0) {
        return (
             <div className="min-h-screen bg-gray-800 flex items-center justify-center p-4">
                <div className="bg-white p-8 rounded-2xl text-center max-w-md w-full animate-bounce-in">
                    <XCircle className="w-24 h-24 text-red-500 mx-auto mb-4" />
                    <h2 className="text-3xl font-bold text-gray-800 mb-2">æŒ‘æˆ°å¤±æ•—...</h2>
                    <p className="text-gray-600 mb-6">ç”Ÿå‘½å€¼æ­¸é›¶äº†ï¼Œåˆ¥æ°£é¤’ï¼Œä¼‘æ¯ä¸€ä¸‹å†è©¦ä¸€æ¬¡ï¼</p>
                    <button onClick={() => setGameState('levelSelect')} className="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-600 w-full">
                        å›åˆ°åœ°åœ–
                    </button>
                </div>
             </div>
        )
    }

    return (
      <div className={`min-h-screen ${theme.color} p-4 flex flex-col relative`}>
        {/* ç­”å°æ™‚è§¸ç™¼ç‘èŠ±ç‰¹æ•ˆï¼Œè®“æ…¶ç¥æ„Ÿæ›´å¼·çƒˆ */}
        {feedback === 'correct' && <Confetti />}

        {/* Header */}
        <div className="flex justify-between items-center max-w-4xl mx-auto w-full mb-6 bg-white/80 backdrop-blur p-4 rounded-xl shadow-sm relative z-10">
          <div className="flex items-center space-x-2">
             <button onClick={() => setGameState('levelSelect')} className="p-2 hover:bg-gray-100 rounded-full mr-2"><Home size={20}/></button>
             <span className={`font-bold ${theme.accent}`}>{currentLevel.title}</span>
          </div>
          <div className="flex items-center space-x-6">
            <div className="flex items-center text-red-500">
               {[...Array(3)].map((_, i) => (
                 <Heart key={i} className={`w-8 h-8 ${i < hp ? 'fill-current' : 'text-gray-300'}`} />
               ))}
            </div>
            <div className="text-xl font-bold text-yellow-600 flex items-center">
              <Star className="w-6 h-6 mr-1 fill-current" /> {score}
            </div>
          </div>
        </div>

        {/* Question Card */}
        <div className="flex-1 flex flex-col items-center justify-center max-w-3xl mx-auto w-full relative z-10">
          <div className="w-full bg-white rounded-3xl shadow-2xl overflow-hidden">
            {/* Progress Bar */}
            <div className="w-full bg-gray-200 h-2">
              <div 
                className={`h-2 ${theme.button.split(' ')[0]}`} 
                style={{ width: `${((currentProblemIndex) / currentLevel.problems.length) * 100}%` }}
              ></div>
            </div>

            <div className="p-8 md:p-12">
              <div className="flex justify-between items-start mb-6">
                <span className="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm font-bold">
                  é¡Œç›® {currentProblemIndex + 1} / {currentLevel.problems.length}
                </span>
                <button 
                    onClick={() => setShowHint(!showHint)} 
                    className="text-yellow-500 hover:text-yellow-600 flex items-center text-sm font-bold"
                >
                    <HelpCircle className="w-5 h-5 mr-1" /> æç¤º
                </button>
              </div>

              <h3 className="text-2xl md:text-3xl font-bold text-gray-800 mb-8 leading-relaxed">
                {currentProblem.q}
              </h3>

              {showHint && (
                  <div className="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 text-yellow-800 animate-fade-in">
                      ğŸ’¡ æç¤ºï¼š{currentProblem.hint}
                  </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {currentProblem.options.map((opt, idx) => (
                  <button
                    key={idx}
                    onClick={() => handleAnswer(opt)}
                    disabled={showExplanation || feedback === 'correct'}
                    className={`p-6 rounded-xl text-xl font-bold transition-all transform hover:scale-102 border-b-4 
                        ${feedback === 'correct' && opt === currentProblem.ans 
                            ? 'bg-green-500 text-white border-green-700' 
                            : feedback === 'wrong' && showExplanation && opt === currentProblem.ans
                                ? 'bg-green-100 text-green-700 border-green-300' // Show correct answer when wrong
                                : 'bg-gray-50 hover:bg-gray-100 border-gray-200 text-gray-700'
                        }
                        ${feedback === 'wrong' && showExplanation && opt !== currentProblem.ans ? 'opacity-50' : ''}
                    `}
                  >
                    {opt}
                  </button>
                ))}
              </div>

              {/* Feedback / Explanation Area */}
              {feedback === 'correct' && (
                  <div className="mt-6 text-center animate-bounce-in">
                      <div className="inline-flex items-center bg-green-100 text-green-700 px-6 py-2 rounded-full text-xl font-bold">
                          <CheckCircle className="w-6 h-6 mr-2" /> ç­”å°äº†ï¼ +100 åˆ†
                      </div>
                  </div>
              )}

              {showExplanation && feedback !== 'correct' && (
                <div className="mt-8 bg-red-50 p-6 rounded-xl border border-red-100 animate-slide-up">
                    <div className="flex items-center text-red-600 font-bold text-xl mb-2">
                        <XCircle className="w-6 h-6 mr-2" /> å“å‘€ï¼Œç­”éŒ¯äº†ï¼
                    </div>
                    <div className="text-gray-700 mb-4 whitespace-pre-line leading-relaxed">
                        {currentProblem.explanation}
                    </div>
                    <button 
                        onClick={nextProblem}
                        className="bg-blue-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-600 w-full md:w-auto"
                    >
                        ä¸‹ä¸€é¡Œ
                    </button>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    );
  }

  // --- å­ç•«é¢: é—œå¡çµç®— ---
  if (gameState === 'summary') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-yellow-100 to-orange-100 flex items-center justify-center p-4 relative overflow-hidden">
        {/* ç‘èŠ±ç‰¹æ•ˆ */}
        <Confetti />
        
        <div className="bg-white p-10 rounded-3xl shadow-2xl text-center max-w-lg w-full relative z-10 animate-bounce-in">
          <Trophy className="w-32 h-32 text-yellow-400 mx-auto mb-6 drop-shadow-lg" />
          <h2 className="text-4xl font-extrabold text-gray-800 mb-4">é—œå¡å®Œæˆï¼</h2>
          <p className="text-xl text-gray-500 mb-8">ä½ çœŸæ˜¯å¤ªå²å®³äº†ï¼</p>
          
          <div className="flex justify-center space-x-8 mb-10">
              <div className="text-center">
                  <div className="text-sm text-gray-400 font-bold uppercase tracking-wider">ç¸½åˆ†</div>
                  <div className="text-3xl font-black text-blue-600">{score}</div>
              </div>
              <div className="text-center">
                  <div className="text-sm text-gray-400 font-bold uppercase tracking-wider">å‰©é¤˜ç”Ÿå‘½</div>
                  <div className="text-3xl font-black text-red-500">{hp}</div>
              </div>
          </div>

          <button 
            onClick={() => setGameState('levelSelect')} 
            className="w-full bg-blue-500 text-white py-4 rounded-xl text-xl font-bold hover:bg-blue-600 shadow-lg transition"
          >
            ç¹¼çºŒå†’éšª
          </button>
        </div>
      </div>
    );
  }

  // --- å­ç•«é¢: çç‹€ ---
  if (gameState === 'certificate') {
    return (
      <div className="min-h-screen bg-slate-800 p-4 flex flex-col items-center justify-center">
        <div className="bg-white p-2 max-w-4xl w-full rounded-lg shadow-2xl mb-8">
            <div className="border-8 border-yellow-500 p-8 md:p-16 text-center relative overflow-hidden bg-yellow-50">
                <Award className="absolute top-4 left-4 w-24 h-24 text-yellow-200 opacity-50" />
                <Award className="absolute bottom-4 right-4 w-24 h-24 text-yellow-200 opacity-50" />
                
                <h1 className="text-5xl md:text-6xl font-black text-yellow-600 mb-8 font-serif tracking-widest">æ¦®è­½è­‰æ›¸</h1>
                
                <p className="text-2xl text-gray-600 mb-4">èŒ²è­‰æ˜</p>
                <input 
                    type="text" 
                    placeholder="è«‹è¼¸å…¥ä½ çš„åå­—" 
                    className="text-4xl md:text-5xl font-bold text-center bg-transparent border-b-4 border-gray-300 focus:border-blue-500 outline-none px-4 py-2 w-full max-w-md mb-8 text-blue-800 placeholder-gray-300"
                    value={userName}
                    onChange={(e) => setUserName(e.target.value)}
                />
                <p className="text-xl md:text-2xl text-gray-600 leading-relaxed mb-12">
                    æˆåŠŸé€šéäº†ã€Œåœ“å‘¨é•·èˆ‡æ‰‡å½¢ã€çš„æ‰€æœ‰è€ƒé©—ï¼Œ<br/>
                    å±•ç¾äº†å“è¶Šçš„æ•¸å­¸èƒ½åŠ›èˆ‡å†’éšªç²¾ç¥ï¼
                </p>

                <div className="flex justify-between items-end mt-12 px-12">
                    <div className="text-center">
                        <div className="w-32 h-32 bg-red-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg transform rotate-12 border-4 border-white mb-2">
                            <span className="text-xl">æ•¸å­¸<br/>å¤§å¸«</span>
                        </div>
                    </div>
                    <div className="text-right">
                        <p className="text-lg text-gray-500 border-t-2 border-gray-400 pt-2 px-8">æ—¥æœŸï¼š{new Date().toLocaleDateString()}</p>
                    </div>
                </div>
            </div>
        </div>
        <div className="flex space-x-4">
             <button onClick={() => window.print()} className="bg-white text-slate-800 px-6 py-3 rounded-lg font-bold hover:bg-gray-100">åˆ—å°è­‰æ›¸</button>
             <button onClick={() => setGameState('levelSelect')} className="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700">å›åˆ°é¦–é </button>
        </div>
      </div>
    );
  }

  return null;
};

// --- ä¸»ç¨‹å¼å…¥å£ ---
const App = () => {
  const [mode, setMode] = useState('menu'); // menu, review, learn, quiz, game

  return (
    <div className="font-sans text-gray-800">
      {mode === 'menu' && <MainMenu onSelectMode={setMode} />}
      {mode === 'review' && <ReviewMode onBack={() => setMode('menu')} />}
      {mode === 'learn' && <LearnMode onBack={() => setMode('menu')} />}
      {mode === 'game' && <GameMode onBack={() => setMode('menu')} />}
      {/* ç°¡åŒ–ï¼šå°‡ Quiz æ•´åˆé€² Game æ¨¡å¼ï¼Œæˆ–å¯æœªä¾†æ“´å…… */}
    </div>
  );
};

export default App;
